#!/usr/bin/env php
<?php
/**
 * Uses composer to install all dependencies required to run or test the
 * project. Downloads composer if it doesn't already exist.
 *
 * PHP.Gt (http://php.gt)
 * @copyright Copyright â’¸ 2015 Bright Flair Ltd. (http://brightflair.com)
 * @license http://www.opensource.org/licenses/mit-license.php MIT
 */
$HOME = $_SERVER["HOME"];
$gtDir = "$HOME/.gt";
$binDir = "$gtDir/PHP.Gt/bin";
$gtBinDir = "$gtDir/bin";

if(is_dir($gtDir)) {
	exec("rm -rf $gtDir");
}
else {
	mkdir($gtDir);
}
chdir($gtDir);

if(!file_exists("composer.phar")) {
	echo "Installing composer..." . PHP_EOL;
	$tempFile = "install-composer.php";
	$installScript = @file_get_contents("https://getcomposer.org/installer");
	if(!$installScript) {
		echo("Failed installing composer. " . PHP_EOL
			. "Are you connected to the internet?" . PHP_EOL);
		exit(1);
	}
	file_put_contents($tempFile, $installScript);
	passthru("php $tempFile", $composerReturn);
	unlink($tempFile);

	if($composerReturn != 0) {
		echo("Something went wrong installing composer :(" . PHP_EOL);
	}
}

passthru("./composer.phar create-project brightflair/php.gt PHP.Gt "
	. "-s'dev' --keep-vcs", $installReturn);
if($installReturn != 0) {
	echo("Something went wrong downloading PHP.Gt :(". PHP_EOL
		. "Are you connected to the internet?" . PHP_EOL);
	exit(1);
}

// OS-dependant stuff:
switch(PHP_OS) {
case "Darwin":
	// OSX
	// OSX does not load .bashrc, instead it loads .bash_profile...
	// let's fix that.
	$bashLoadScript = "$HOME/.bash_profile";

	$bashExisting = "";
	if(file_exists($bashLoadScript)) {
		$bashExisting = file_get_contents($bashLoadScript);
	}
	if(!strstr($bashExisting, "#gt")) {
		// TODO: Remove existing gt snippet rather than ignoring completely.
		$bash = <<<BASH

#gt

[[ -s ~/.bashrc ]] && source ~/.bashrc

#gt-end

BASH;
	file_put_contents($bashLoadScript, $bash, FILE_APPEND);
	}
	break;

default:
	break;
}

if(!is_dir($gtBinDir)) {
	mkdir($gtBinDir, 0775, true);
}

foreach (new DirectoryIterator($binDir) as $item) {
	if($item->isDot()) {
		continue;
	}

	$filename = $item->getFilename();
	$pathname = $item->getPathname();
	$linkname = "$gtBinDir/gt-$filename";

	if(file_exists($linkname)) {
		unlink($linkname);
	}

	symlink($pathname, $linkname);
}

$bashLoadScript = "$HOME/.bashrc";
$bashExisting = "";
if(file_exists($bashLoadScript)) {
	$bashExisting = file_get_contents($bashLoadScript);
}
if(!strstr($bashExisting, "#gt")) {
	// TODO: Remove existing gt snippet rather than ignoring completely.
	// Add gtBinDir to path.
	$bash = <<<BASH

#gt

if [[ ":\$PATH:" != *":$gtBinDir:"* ]]; then
  PATH=\$PATH:$gtBinDir
  export PATH
fi

#gt-end

BASH;
	file_put_contents($bashLoadScript, $bash, FILE_APPEND);
}

echo PHP_EOL . "PHP.Gt successfully installed." . PHP_EOL
	. "Restart your terminal to use gt-* commands." . PHP_EOL
	. PHP_EOL;