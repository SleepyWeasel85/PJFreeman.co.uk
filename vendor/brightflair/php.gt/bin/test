#!/usr/bin/env php
<?php
/**
 * Initiate tests within current project. Exits with status code 0 on successful
 * test run, 1 for failed Unit test, 2 on failed Acceptance test, 3 on failed
 * Unit and failed Acceptance test.
 *
 * Usage: test [-a|--approot[="..."]] [--type="unit|acceptance|all"]
 *
 * PHP.Gt (http://php.gt)
 * @copyright Copyright Ⓒ 2015 Bright Flair Ltd. (http://brightflair.com)
 * @license http://www.opensource.org/licenses/mit-license.php MIT
 */
use Gt\Cli\TestRunner;
use Symfony\Component\Console\Input\InputDefinition;
use Symfony\Component\Console\Input\InputArgument;
use Symfony\Component\Console\Input\InputOption;
use Symfony\Component\Console\Input\ArgvInput;

// PHP.Gt should always be loaded as a Composer dependency. The vendor directory
// will be in the project's root directory — not PHP.Gt's root directory.
// We first need to find the root directory by working up the directory tree
// until the vendor directory is found.
$vendorDirectory = null;
while(true) {
	$cwd = getcwd();
	if(is_dir("$cwd/vendor")) {
		$vendorDirectory = "$cwd/vendor";
		break;
	}
	chdir("..");

	if(getcwd() === $cwd) {
		// We have reached the root directory of the filesystem without finding
		// the vendor directory.
		echo "No vendor directory found.\n"
			. "Have you performed a composer install?\n\n"
			. "See http://www.php.gt/docs/installation for more information.\n";
		exit(1);
	}
}

$vendorAutoLoadFile = realpath("$vendorDirectory/autoload.php");
if(!file_exists($vendorAutoLoadFile)) {
	echo "No Composer autoloader script found.\n"
		. "Have you performed a composer install?\n\n"
		. "See http://www.php.gt/docs/installation for more information.\n";
	exit(1);
}
require($vendorAutoLoadFile);

$defaults = [
	"approot" => $cwd,
	"type" => "all",
];

$definition = new InputDefinition([
	new InputArgument("approot", InputArgument::OPTIONAL),
	new InputOption("approot", "a", InputOption::VALUE_OPTIONAL,
		"Application root directory", $defaults["approot"]),

	new InputArgument("type", InputArgument::OPTIONAL),
	new InputOption("type", "t", InputOption::VALUE_OPTIONAL,
		"Type of test to run", $defaults["type"]),
]);

try {
	$input = new ArgvInput($argv, $definition);
	$approot = $input->getOption("approot");
	$type = $input->getOption("type");

	new TestRunner($approot, $type);
	exit(0);
}
catch(Exception $e) {
	if($e instanceof \Gt\Cli\InvalidTestRunnerTypeException) {
		echo "\nINVALID TYPE: " . $e->getMessage() . "\n";
	}
	echo "\nstest shell script usage:\n";
	echo $definition->getSynopsis();
	echo "\n\n";
	echo strip_tags($definition->asText());
	echo "\n";
	exit(1);
}
